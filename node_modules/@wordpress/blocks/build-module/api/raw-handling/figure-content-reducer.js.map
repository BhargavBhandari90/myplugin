{"version":3,"sources":["@wordpress/blocks/src/api/raw-handling/figure-content-reducer.js"],"names":["has","isTextContent","isFigureContent","node","schema","tag","nodeName","toLowerCase","canHaveAnchor","wrapFigureContent","element","beforeElement","figure","ownerDocument","createElement","parentNode","insertBefore","appendChild","figureContentReducer","doc","nodeToInsert","childNodes","length","wrapper","closest","classList","contains","textContent","trim"],"mappings":"AAAA;AACA;AACA;AACA,SAASA,GAAT,QAAoB,QAApB;AAEA;AACA;AACA;;AACA,SAASC,aAAT,QAA8B,gBAA9B;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA,SAASC,eAAT,CAA0BC,IAA1B,EAAgCC,MAAhC,EAAyC;AACxC,QAAMC,GAAG,GAAGF,IAAI,CAACG,QAAL,CAAcC,WAAd,EAAZ,CADwC,CAGxC;AACA;;AACA,MAAKF,GAAG,KAAK,YAAR,IAAwBJ,aAAa,CAAEE,IAAF,CAA1C,EAAqD;AACpD,WAAO,KAAP;AACA;;AAED,SAAOH,GAAG,CAAEI,MAAF,EAAU,CAAE,QAAF,EAAY,UAAZ,EAAwBC,GAAxB,CAAV,CAAV;AACA;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASG,aAAT,CAAwBL,IAAxB,EAA8BC,MAA9B,EAAuC;AACtC,QAAMC,GAAG,GAAGF,IAAI,CAACG,QAAL,CAAcC,WAAd,EAAZ;AAEA,SAAOP,GAAG,CAAEI,MAAF,EAAU,CAAE,QAAF,EAAY,UAAZ,EAAwB,GAAxB,EAA6B,UAA7B,EAAyCC,GAAzC,CAAV,CAAV;AACA;AAED;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASI,iBAAT,CAA4BC,OAA5B,EAA+D;AAAA,MAA1BC,aAA0B,uEAAVD,OAAU;AAC9D,QAAME,MAAM,GAAGF,OAAO,CAACG,aAAR,CAAsBC,aAAtB,CAAqC,QAArC,CAAf;AACAH,EAAAA,aAAa,CAACI,UAAd,CAAyBC,YAAzB,CAAuCJ,MAAvC,EAA+CD,aAA/C;AACAC,EAAAA,MAAM,CAACK,WAAP,CAAoBP,OAApB;AACA;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,eAAe,SAASQ,oBAAT,CAA+Bf,IAA/B,EAAqCgB,GAArC,EAA0Cf,MAA1C,EAAmD;AACjE,MAAK,CAAEF,eAAe,CAAEC,IAAF,EAAQC,MAAR,CAAtB,EAAyC;AACxC;AACA;;AAED,MAAIgB,YAAY,GAAGjB,IAAnB;AACA,QAAMY,UAAU,GAAGZ,IAAI,CAACY,UAAxB,CANiE,CAQjE;AACA;;AACA,MACCP,aAAa,CAAEL,IAAF,EAAQC,MAAR,CAAb,IACAW,UAAU,CAACT,QAAX,KAAwB,GADxB,IAEAS,UAAU,CAACM,UAAX,CAAsBC,MAAtB,KAAiC,CAHlC,EAIE;AACDF,IAAAA,YAAY,GAAGjB,IAAI,CAACY,UAApB;AACA;;AAED,QAAMQ,OAAO,GAAGH,YAAY,CAACI,OAAb,CAAsB,OAAtB,CAAhB,CAlBiE,CAoBjE;AACA;AACA;;AACA,MAAKD,OAAL,EAAe;AACd;AACA;AACA,QAAK,CAAEpB,IAAI,CAACsB,SAAZ,EAAwB;AACvBhB,MAAAA,iBAAiB,CAAEW,YAAF,EAAgBG,OAAhB,CAAjB;AACA,KAFD,MAEO,IACNpB,IAAI,CAACsB,SAAL,CAAeC,QAAf,CAAyB,YAAzB,KACAvB,IAAI,CAACsB,SAAL,CAAeC,QAAf,CAAyB,WAAzB,CADA,IAEAvB,IAAI,CAACsB,SAAL,CAAeC,QAAf,CAAyB,aAAzB,CAFA,IAGA,CAAEH,OAAO,CAACI,WAAR,CAAoBC,IAApB,EAJI,EAKL;AACDnB,MAAAA,iBAAiB,CAAEW,YAAF,EAAgBG,OAAhB,CAAjB;AACA;AACD,GAbD,MAaO,IAAKH,YAAY,CAACL,UAAb,CAAwBT,QAAxB,KAAqC,MAA1C,EAAmD;AACzDG,IAAAA,iBAAiB,CAAEW,YAAF,CAAjB;AACA;AACD","sourcesContent":["/**\n * External dependencies\n */\nimport { has } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { isTextContent } from '@wordpress/dom';\n\n/**\n * Whether or not the given node is figure content.\n *\n * @param {Node}   node   The node to check.\n * @param {Object} schema The schema to use.\n *\n * @return {boolean} True if figure content, false if not.\n */\nfunction isFigureContent( node, schema ) {\n\tconst tag = node.nodeName.toLowerCase();\n\n\t// We are looking for tags that can be a child of the figure tag, excluding\n\t// `figcaption` and any phrasing content.\n\tif ( tag === 'figcaption' || isTextContent( node ) ) {\n\t\treturn false;\n\t}\n\n\treturn has( schema, [ 'figure', 'children', tag ] );\n}\n\n/**\n * Whether or not the given node can have an anchor.\n *\n * @param {Node}   node   The node to check.\n * @param {Object} schema The schema to use.\n *\n * @return {boolean} True if it can, false if not.\n */\nfunction canHaveAnchor( node, schema ) {\n\tconst tag = node.nodeName.toLowerCase();\n\n\treturn has( schema, [ 'figure', 'children', 'a', 'children', tag ] );\n}\n\n/**\n * Wraps the given element in a figure element.\n *\n * @param {Element} element       The element to wrap.\n * @param {Element} beforeElement The element before which to place the figure.\n */\nfunction wrapFigureContent( element, beforeElement = element ) {\n\tconst figure = element.ownerDocument.createElement( 'figure' );\n\tbeforeElement.parentNode.insertBefore( figure, beforeElement );\n\tfigure.appendChild( element );\n}\n\n/**\n * This filter takes figure content out of paragraphs, wraps it in a figure\n * element, and moves any anchors with it if needed.\n *\n * @param {Node}     node   The node to filter.\n * @param {Document} doc    The document of the node.\n * @param {Object}   schema The schema to use.\n *\n * @return {void}\n */\nexport default function figureContentReducer( node, doc, schema ) {\n\tif ( ! isFigureContent( node, schema ) ) {\n\t\treturn;\n\t}\n\n\tlet nodeToInsert = node;\n\tconst parentNode = node.parentNode;\n\n\t// If the figure content can have an anchor and its parent is an anchor with\n\t// only the figure content, take the anchor out instead of just the content.\n\tif (\n\t\tcanHaveAnchor( node, schema ) &&\n\t\tparentNode.nodeName === 'A' &&\n\t\tparentNode.childNodes.length === 1\n\t) {\n\t\tnodeToInsert = node.parentNode;\n\t}\n\n\tconst wrapper = nodeToInsert.closest( 'p,div' );\n\n\t// If wrapped in a paragraph or div, only extract if it's aligned or if\n\t// there is no text content.\n\t// Otherwise, if directly at the root, wrap in a figure element.\n\tif ( wrapper ) {\n\t\t// In jsdom-jscore, 'node.classList' can be undefined.\n\t\t// In this case, default to extract as it offers a better UI experience on mobile.\n\t\tif ( ! node.classList ) {\n\t\t\twrapFigureContent( nodeToInsert, wrapper );\n\t\t} else if (\n\t\t\tnode.classList.contains( 'alignright' ) ||\n\t\t\tnode.classList.contains( 'alignleft' ) ||\n\t\t\tnode.classList.contains( 'aligncenter' ) ||\n\t\t\t! wrapper.textContent.trim()\n\t\t) {\n\t\t\twrapFigureContent( nodeToInsert, wrapper );\n\t\t}\n\t} else if ( nodeToInsert.parentNode.nodeName === 'BODY' ) {\n\t\twrapFigureContent( nodeToInsert );\n\t}\n}\n"]}